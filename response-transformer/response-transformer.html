<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../paper-toast/paper-toast.html">
<link rel="import" href="../../paper-button/paper-button.html">
<link rel="import" href="../../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../paper-dialog/paper-dialog.html">
<link rel="import" href="../../iron-icons/iron-icons.html">
<link rel="import" href="../../iron-ajax/iron-ajax.html">
<link rel="import" href="../../t-input/t-input.html">

<link rel="import" href="../ace-element/ace-lib.html">
<link rel="import" href="../ace-element/indentation-icon.html">

<dom-module id="response-transformer">
  <template>
    <style>
      :host {
        display: block;
      }

      paper-icon-button {
        background-color: #F0F0F0;
        border-radius: 50% 50%;
        margin-left: 15px;
      }

      #editor-dialog {
        z-index: 106 !important;
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        margin: 0;
      }

      #editor-dialog .editors-container {
        font-size: 14px;
        box-sizing: border-box;
        height: calc(100% - 136px);
        width: 100%;
        position: relative;
      }

      .left, .right {
        position: absolute;
        bottom: 0;
        top: 0;
      }

      .left {
        left: 24px;
        right: calc(100% / 2);
      }

      .right {
        left: calc(100% / 2);
        right: 24px;
      }

      .right #transform,
      .right #output {
        height: calc(100% / 2);
      }

      #input {
        height: calc(100% - 100px);
      }

      #input, #transform, #output {
        border: 1px solid #777;
      }

      .right .transform-buttons {
        position: absolute;
        right: 2px;
        top: 2px;
        z-index: 110;
      }
    </style>

    <paper-button raised on-tap="openEditor">Open</paper-button>
    <iron-ajax id="fetch" url="{{url}}" handle-as="json" on-response="handleResponse"></iron-ajax>
    <paper-toast id="toast"></paper-toast>

    <paper-dialog id="editor-dialog" modal>
      <h2>{{title}} <paper-icon-button icon="indent:prettify" on-tap="prettify"></paper-icon-button></h2>
      <div class="editors-container">
        <div class="left">
          <div class="input-url">
            <t-input label="URL" value="{{url}}"></t-input>
            <paper-icon-button icon="icons:arrow-forward" on-tap="generateRequest"></paper-icon-button>
          </div>
          <div id="input"></div>
        </div>
        <div class="right">
          <div id="transform"></div>
          <div id="output"></div>
          <div class="transform-buttons">
            <paper-icon-button icon="icons:arrow-forward" on-tap="transformInput"></paper-icon-button>
          </div>
        </div>
      </div>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm on-tap="saveDataSource">Save</paper-button>
      </div>
    </paper-dialog>
  </template>
  <script>
    Polymer({
      is: 'response-transformer',

      properties: {
        title: String,
        url: String,
        transform: {
          type: Function,
          observer: 'initTransform'
        },
        translator:{
          type: Function,
          observer: 'initTranslator'
        },
        dataSource: {
          type: Object,
          notify: true
        }
      },

      attached: function() {
        this.initializeEditors();
        this.setValue(this.transformEditor, this.transform);

        if (!this.transform) {
          this.transform = function transform(inp) {
            return inp;
          };
        }

        if (!this.translator) {
          this.translator = function translator(inp) {
            return inp;
          };
        }
      },

      initializeEditors: function() {
        this.inputEditor = ace.edit(this.$.input);
        this.transformEditor = ace.edit(this.$.transform);
        this.outputEditor = ace.edit(this.$.output);

        ['inputEditor', 'transformEditor', 'outputEditor']
          .forEach(function(editor) {
            this[editor].setTheme('ace/theme/github');
            this[editor].getSession().setTabSize(2);
            this[editor].getSession().setUseSoftTabs(true);
            this[editor].setShowPrintMargin(false);
          }.bind(this));

        this.inputEditor.getSession().setMode('ace/mode/json');
        this.outputEditor.getSession().setMode('ace/mode/json');
        this.transformEditor.getSession().setMode('ace/mode/javascript');

        this.inputEditor.setReadOnly(true);
        this.outputEditor.setReadOnly(true);
      },

      _isString: function(val) {
        return Object.prototype.toString.call(val) === '[object String]';
      },

      initTransform: function(newTransform) {
        if (newTransform && this._isString(newTransform)) {
          /* jshint -W061 */
          eval(newTransform);
          this.transform = transform;
        }
      },

      initTranslator: function(newTranslator) {
        if (newTranslator && this._isString(newTranslator)) {
          /* jshint -W061 */
          eval(newTranslator);
          this.translator = translator;
        }
      },

      openEditor: function() {
        this.$['editor-dialog'].open();
      },

      closeEditor: function() {
        this.$['editor-dialog'].close();
      },

      setValue: function(editor, val) {
        val = val ? val.toString() : '';
        editor.setValue(val);
        editor.selection.clearSelection();
        editor.scrollToLine(0);
      },

      generateRequest: function() {
        this.$.fetch.generateRequest();
      },

      handleResponse: function(event) {
        var strResp, resp = event.detail.response;

        //TODO: what validations does inpur response need?
        if (!resp) {
          this.$.toast.text = 'Invalid api response';
          this.$.toast.open();

          return;
        }

        strResp = JSON.stringify(resp, null, 2);
        this.setValue(this.inputEditor, strResp);
        this.inputData = resp;
      },

      transformInput: function() {
        var translator, outputData, strOutputData;
        var inputData = this.inputData;
        var idFunc = function (inp) { return inp; };

        if (!this.inputData) {
          //TODO: tell user that he has to have api response first
          return;
        }

        this.transform = this.transformEditor.getValue();
        translator = this.translator || idFunc;

        try {
          outputData = this.transform(inputData);
          strOutputData = JSON.stringify(outputData, null, 2);
          translator(outputData);
          this.setValue(this.outputEditor, strOutputData);
        } catch (err) {
          this.$.toast.text = 'Invalid transform output';
          this.$.toast.open();

          throw err;
        }
      },

      getDataSource: function() {
        var url = this.url, transform = this.transform;
        var translator = this.translator;

        if (!url || !transform || !translator) return;

        transform = 'function transform(inputData) { ' +
          transform.toString() + ' ' +
          translator.toString() + ' ' +
          ' return translator(transform(inputData)); ' +
        '}';

        return {
          url: url,
          transform: transform
        };
      },

      saveDataSource: function(event) {
        try {
          this.transformInput();
          this.dataSource = this.getDataSource();
        } catch (err) {
          event.stopPropagation();
          event.preventDefault();
        }
      }
    });
  </script>
</dom-module>
